(function(w,d){
var U=w.SAFE_UI,C=w.SAFE_CRYPTO;
function init(){if(!U||!C)return;var flow=d.getElementById("decryptFlow");if(!flow)return;var selectedFile=null;var dropRoot=flow.querySelector(".card--file");U.setupDropzone({root:dropRoot,acceptSafeOnly:true,onFileSelected:function(f){selectedFile=f}});var passwordInput=d.getElementById("decryptPassword");var eyeBtn=flow.querySelector(".form--decrypt .icon-btn--eye");U.attachPeekBehavior(eyeBtn,passwordInput);var captchaGroup=flow.querySelector(".form--decrypt .field-group--captcha");var captchaManager=U.createCaptchaManager(captchaGroup);var startBtn=flow.querySelector(".flow-actions .btn--primary");var statusCard=flow.querySelector(".status-card");var progressEl=statusCard?statusCard.querySelector(".progress"):null;var progressFill=statusCard?statusCard.querySelector(".progress__fill"):null;var statusText=statusCard?statusCard.querySelector(".status-card__text"):null;var statusBadge=statusCard?statusCard.querySelector(".status-card__badge"):null;function setProgress(p,t){if(progressFill)progressFill.style.width=p+"%";if(progressEl)progressEl.setAttribute("aria-valuenow",String(p));if(statusText&&t)statusText.textContent=t;if(statusBadge)statusBadge.textContent=p>=100?"انجام شد":"در حال پردازش"}function handleStart(){if(!selectedFile){alert("لطفاً ابتدا فایل SAFE را انتخاب کنید.");return}var password=passwordInput.value.trim();if(!password){alert("لطفاً رمز عبور را وارد کنید.");return}if(captchaManager){var c=captchaManager.validate();if(!c.ok){if(c.reason==="bot")alert("درخواست مشکوک به فعالیت رباتی است.");else if(c.reason==="empty")alert("لطفاً متن کپچا را وارد کنید.");else{alert("کپچا اشتباه است. لطفاً دوباره تلاش کنید.");captchaManager.regenerate()}return}}startBtn.disabled=true;setProgress(0,"در صف رمزگشایی...");C.decryptSafeFile(selectedFile,password,function(p,t){setProgress(p,t)}).then(function(res){var buf=res.buffer,meta=res.metadata;var type=(meta&&meta.type)||"application/octet-stream";var name=(meta&&meta.name)||selectedFile.name||"file";var blob=new Blob([buf],{type:type});var url=URL.createObjectURL(blob);var a=d.createElement("a");a.href=url;a.download=name;d.body.appendChild(a);a.click();setTimeout(function(){d.body.removeChild(a);URL.revokeObjectURL(url)},0);alert("فایل با موفقیت رمزگشایی و برای دانلود آماده شد.");}).catch(function(err){console.error(err);alert(err&&err.message?err.message:"خطایی در فرآیند رمزگشایی رخ داد. لطفاً رمز یا فایل را بررسی کنید.");}).finally(function(){startBtn.disabled=false})}if(startBtn)startBtn.addEventListener("click",function(e){e.preventDefault();handleStart()})}
w.SAFE_DECRYPT_UI={init:init};
})(window,document);
